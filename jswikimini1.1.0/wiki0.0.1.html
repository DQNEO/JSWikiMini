<html>
<!-- JSWikiMini Version 1.0.1 -->
<head>
<script>
/** 初期設定 */
try{
    var fso = new ActiveXObject("Scripting.FileSystemObject");
}catch(e){
    alert("Error:" + e.message);
}

/** Parameters */

var wiki = {
    debug : false,
    regLink : /((mailto|http|https|ftp):[\x21-\x7E]*)|([A-Z][a-z]+([A-Z][a-z]+)+)/g,
    regWikiName : /[A-Z][a-z]+([A-Z][a-z]+)+/,
    FirstPageName : 'FrontPage',
    IndexPageName : 'Index',

    elmContent : null,
    elmHeaderH1: null,

    dump : function (str){
            if(this.debug){ alert(str); }
           },

    dummy : 0

};


//============  Storage Class ===================
wiki.storage = {}
wiki.storage.init = function(){
}

wiki._DBinit = function(){
    this._DB_setBaseFolder();
    this.storage.init();
}

wiki.storage._regExtension = /\.txt$/i;

wiki._DBread = function (pagename){
    var file = fso.openTextFile(this._DB_getPagePath(pagename));
    var content = file.readAll();
    file.Close();
    return content;
}

wiki._DBexists = function(pagename){
    var filepath = this._DB_getPagePath(pagename);
    return fso.fileExists(filepath);
}

wiki._DBkeys = function (){
    var TextFiles = this._DB_getFiles(this._DB_getBaseFolder(), this.storage._regExtension);
    var PageNames = [];
    for(var i in TextFiles){
        PageNames.push(fso.getBaseName(TextFiles[i]));
    }
    return PageNames;
}


wiki._DBstore = function (pagename, message){
    var file = fso.createTextFile( this._DB_getPagePath(pagename));
    file.write(message);
    file.Close();
    return;
}

wiki._DBdelete = function (pagename){
    if(this._DBexists(pagename)){
        fso.deleteFile(this._DB_getPagePath(pagename));
        return true;
    }else{
        return false;
    }
}


wiki._DB_getPagePath = function (pagename){
    return this._DB_getBaseFolder().Path + "\\" +  pagename + ".txt";
}



wiki._DB_getFiles = function (objFolder, filter) {
   var objEnu = new Enumerator(objFolder.Files);
   var files = [];
   for (; !objEnu.atEnd(); objEnu.moveNext() ){
       if(objEnu.item().Name.match(filter)){
   files.push(objEnu.item());
       }
   }
   return files;
}


wiki._DB_setBaseFolder = function () {
    var FullPath = location.href.replace(/file:\/\/\//, "").replace(/file:\/\//,"//").replace(/%20/g, " ");

    if(fso.fileExists(FullPath)){
        var BaseFile = fso.getFile(FullPath);
    }else{
        alert('File not Exists:' + FullPath);
    }

    this._DB_oBaseFolder = BaseFile.parentFolder;
}

wiki._DB_getBaseFolder = function (){
    return this._DB_oBaseFolder;
}


wiki.init = function(){

    this._DBinit();
    this.elmContent = this.$id('content');
    this.elmHeaderH1 = this.$id('headerH1');
    this.openPage(this.FirstPageName);

}


wiki.showIndexPage = function (){
    this._setPageTitle(this.IndexPageName);
    this.$id("editLink").style.display = "none";

    var PageNames = this._DBkeys();
    var links = [];
    for(var i in PageNames){
        var li = "<li><a href='javascript:wiki.openPage(\""+PageNames[i]+"\");'>" + PageNames[i] + "</a></li>";
        
        links.push(li);
    }
    this.elmContent.innerHTML = "<ul>" + links.join("") + "</ul>";
    
};

wiki.editCurrentPage =  function(){
    this.editPage(this._getCurrentPageName());
};

wiki._getCurrentPageName = function(){
    return document.title;
}


wiki.savePage = function (pagename){
    
    var message = this.$id('textarea').value;
    
    if( message ){
        this._DBstore(pagename, message);
        this.openPage(pagename);
    }else{
        var ret = this._DBdelete(pagename);
        this.dump(ret);
        this.openPage(this.FirstPageName);
        return false;
    }

    
    return false;
}


wiki.editPage = function (pagename){

    this._setPageTitle(pagename);

    var content = '';


    if( this._DBexists(pagename) ){
        content = this._DBread(pagename);
    }

    var html =
       "<form onsubmit='wiki.savePage(\"" + pagename + "\"); return false;'>"
//     + "<input type='submit' value='submit'><br />"
     + "<textarea cols='80' rows='20' id='textarea' wrap='off'>" + content + "</textarea><br />"
     + "<input type='submit' value='submit'><br />"
     + "</form>";

    this.elmContent.innerHTML = html;

}

wiki.openPage = function (pagename){
    this._setPageTitle(pagename);
   this.$id("editLink").style.display = "inline";

    if(! this._DBexists(pagename) ){
        this.elmContent.innerHTML = "";
        return;
    }else{
        var content = this._DBread(pagename);
        content = content.replace(this.regLink, this.makeLink );
        this.elmContent.innerHTML = "<pre>" + content + "</pre>";
    }

}


wiki.makeLink = function ($0,$1,$2){
    var matched = $0;
    var link;
    //alert("$0:" + $0 + "\n$1:" + $1 + "\n$2:" + $2 );

    if(matched.match(wiki.regWikiName)){
    //WikiNameとマッチした場合
        pagename = matched;
        if(wiki._DBexists(pagename)){
            link = "<a href='javascript:wiki.openPage(\""
                 + pagename
                 + "\");'>" + pagename + "</a>";
             
        }else{
            link = pagename + "<a href='javascript:wiki.editPage(\"" + pagename + "\")' title='create a Page'>?</a>";
            
        }
    }else{
    //URLとマッチした場合
        link = "<a href='" + matched + "'>" + matched + "</a>";
    }
    
    return link;
}


wiki._setPageTitle = function(pagename){
    document.title = pagename;
    this.elmHeaderH1.innerText = pagename;
};


wiki.$id = function (id){
    return document.getElementById(id);
}




</script>

<style type="text/css">
<!--
body { font-family: "Courier New", monospace; }
pre { line-height:130%; }
a { text-decoration: none }
a:hover { text-decoration: underline }
-->
</style>
                
    </head>
    <body bgcolor="white" onload="wiki.init()">
        <table width="100%" border="0">
            <tr valign="top">
                <td>
                    <h1 id="headerH1">FrontPage</h1>
                </td>
                <td align="right">
                    <a href="javascript:wiki.openPage('FrontPage')">FrontPage</a> | 
                    <span id="editLink"><a href="javascript:wiki.editCurrentPage()">Edit</a> | </span>
                    <a href="javascript:wiki.showIndexPage()">Index</a> | 
                </td>
            </tr>
        </table>
    <div id="content"></div>

    </body>
</html>



