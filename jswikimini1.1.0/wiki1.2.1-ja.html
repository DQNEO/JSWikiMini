<!DOCTYPE html>
<html>
<!-- JSWikiMini Version 1.0 -->
<head>
<meta charset="shift_JIS">
<script>
/*
JSWikiMini Version 1.1.0
-1.1.0    MVC構造になるように大規模にリファクタリングした。グローバル変数を１つのみにした。
-1.1.1   HTMLとJSを完全に分離した。
-1.2.1
*/
var wiki = {
    /* config */
    config : {
        HomePageName : 'トップページ',

        IndexPageName : 'ページ一覧',
        regLink : /((mailto|http|https|ftp):[\x21-\x7E]*)|<(.+)>/g,
        WikiPattern : /<(.+)>/,

        dummy : null
    },
    
    main : function() {

    var ret = this.db.init();
    if(ret === false){
        return false;
    }

    this.view._id("linkToHomePage").onclick   = function(){
      wiki.openHomePage();
      return false;
    };

    this.view._id("linkToEditPage").onclick  = function(){
      wiki.editCurrentPage();
      return false;
    };

    this.view._id("linkToIndexPage").onclick = function(){
      wiki.openIndexPage();
      return false; 
    };

    this.openHomePage();

}
};

wiki.openPage = function (pagename){

    this.view.setPageTitle(pagename);
    this.view.showEditLink();

    if(! this.db.exists(pagename) ){
        this.view.setContent('');
        return ;
    }else{
        var content = this.db.read(pagename);
        //alert(content);
        content = content.replace(this.config.regLink, this.makeLink );
        //alert(content);
        this.view.setContent("<pre>" + content + "</pre>");
        return ;
    }

}

wiki.openHomePage = function(){
    this.openPage(this.config.HomePageName);
};

wiki.openIndexPage = function (){

    this.view.setPageTitle(this.config.IndexPageName);
    this.view.hideEditLink();

    var PageNames = this.db.keys();

    this.view.renderIndexPage(PageNames);
    
};


wiki.savePage = function (pagename){
    
    var content = this.view.getInputValue();
    
    if( content ){
        this.db.save(pagename, content);
        this.openPage(pagename);
    }else{
        var ret = this.db.remove(pagename);
        this.openHomePage();
    }
    
    return false;
}


wiki.editCurrentPage =  function(){
    this.editPage( this.view.getCurrentPageName() );
};


wiki.editPage = function (pagename){

    this.view.setPageTitle(pagename);

    var content;

    if( this.db.exists(pagename) ){
        content = this.db.read(pagename);
    }else{  
        content = '';
    }

    this.view.renderInputForm(pagename, content);

}

// cannot bind this 
// this method is a callback
wiki.makeLink = function ($0,$1,$2){
    var matched = $0;
    var link;
    //alert("$0:" + $0 + "\n$1:" + $1 + "\n$2:" + $2 );

    if(matched.match(wiki.config.WikiPattern)){
        //alert("RegExp.$1:" + RegExp.$1);
        pagename = RegExp.$1;
        if(wiki.db.exists(pagename)){
            link = "<a href='javascript:wiki.openPage(\"" + pagename + "\");'>" + pagename + "</a>";
             
        }else{
            link = pagename + "<a href='javascript:wiki.editPage(\"" + pagename + "\")' title='create a Page'>?</a>";
            
        }
    }else{
    //URLとマッチした場合
        link = "<a href='" + matched + "'>" + matched + "</a>";
    }
    
    return link;
}

//============  Storage Object ===================
wiki.db = {
    _fso : null,
    _regExtension : /\.txt$/i,

    init : function() {
        try{
            this._fso = new ActiveXObject("Scripting.FileSystemObject");
        }catch(e){
            var str = "" //"エラー:\r\n" + e.message + "\r\n\r\n"
                   + "ActiveXを実行できませんでした。下記を試してみてください。\r\n\r\n"
                   + "・ブラウザのインターネットオプション＞セキュリティ＞イントラネット＞レベルのカスタマイズでActiveXの実行を許可する。\r\n"
                   + "・このHTMLファイルを右クリックして、「ブロックの解除」をする。\r\n"
                   + "\r\n"
                   + "(本ソフトウェアのご利用は自己責任でお願いします。)"

            alert(str);
            return;
        }
    },

    read : function(pagename) {
        var file = this._fso.openTextFile(this._getPagePath(pagename));
        var content = file.readAll();
        file.Close();
        return content;
    },

    exists : function(pagename) {
        var filepath = this._getPagePath(pagename);
        return this._fso.fileExists(filepath);
    },

    keys : function() {
        var TextFiles = this._getFiles(this._getBaseFolder(), this._regExtension);
        var PageNames = [];
        for(var i in TextFiles){
            PageNames.push(this._fso.getBaseName(TextFiles[i]));
        }
        return PageNames;
    },

    save : function(pagename, message) {
        var file = this._fso.createTextFile(this._getPagePath(pagename));
        file.write(message);
        file.Close();
        return;
    },

    remove : function(pagename) {
        if(this.exists(pagename)){
            this._fso.deleteFile(this._getPagePath(pagename));
            return true;
        }else{
            return false;
        }
    },

    _getPagePath : function(pagename) {
        return this._getBaseFolder().Path + "\\" +  pagename + ".txt";
    },

    _getFiles : function (objFolder, filter) {
       var objEnu = new Enumerator(objFolder.Files);
       var files = [];
       for (; !objEnu.atEnd(); objEnu.moveNext() ){
           if(objEnu.item().Name.match(filter)){
       files.push(objEnu.item());
           }
       }
       return files;
    },

    _getBaseFolder : function() {
        var BaseURL = location.href;
        var FullPath = BaseURL.replace(/file:\/\/\//, "").replace(/file:\/\//,"//").replace(/%20/g, " ");

        if(this._fso.fileExists(FullPath)){
          var thisFile = this._fso.getFile(FullPath);
        }else{
          alert('File not Exists:' + FullPath);
        }
        return thisFile.parentFolder;
    },

    dummy : null
};// db

//============  View Object ===================
wiki.view = {






    setPageTitle : function(pagename) {
        document.title = pagename;
        this._id("headerH1").innerText = pagename;
    },

    showEditLink : function() {
        this._id("editLink").style.display = "inline";
    },

    hideEditLink : function() {
        this._id("editLink").style.display = "none";
    },

    _id : function (id) {
        return document.getElementById(id);
    },

    setContent : function(html) {
        this._id('content').innerHTML = html;
    },

    getCurrentPageName : function() {
        return document.title;
    },

    getInputValue : function() {
        return this._id('textarea').value;
    },

    renderInputForm : function(pagename, content) {
        var html =
           "<form onsubmit='wiki.savePage(\"" + pagename + "\"); return false;'>"
         + "<input type='submit' value='save'><br />"
         + "<textarea cols='80' rows='20' id='textarea' wrap='off'>" + content + "</textarea><br />"
         + "<input type='submit' value='save'><br />"
         + "</form>";

        this.setContent(html);
    },

    renderIndexPage : function(pagenames) {
        var links = [];
        for(var i in pagenames){
            var li = "<li><a href='javascript:wiki.openPage(\""+pagenames[i]+"\");'>" + pagenames[i] + "</a></li>";
            links.push(li);
        }
        this.setContent("<ul>" + links.join("") + "</ul>");
    },

    dummy : null
};

window.onload = function(){ wiki.main() };
</script>

<style>
body { font-family: "Courier New", monospace; }
pre { line-height:130%; }
a { text-decoration: none }
a:hover { text-decoration: underline }
table { width:100%; border:none; }
</style>
                
    </head>
    <body>
        <table>
            <tr valign="top">
                <td>
                    <h1 id="headerH1"></h1>
                </td>
                <td align="right">
                    <a id="linkToHomePage" href="#">トップページ</a> | 
                    <span id="editLink"><a href="" id="linkToEditPage">編集</a> | </span>
                    <a href="" id="linkToIndexPage">ページ一覧</a> | 
                    <a id="linkToHelpPage" href="#">Help</a> | 
                </td>
            </tr>
        </table>
    <div id="content"></div>

    </body>
</html>
